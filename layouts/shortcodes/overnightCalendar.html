{{ $airtableAuthToken := getenv "HUGO_AIRTABLE_AUTH_TOKEN" }}
{{ $airtableBaseId := getenv "HUGO_AIRTABLE_BASE_ID" }}
{{ $airtablePayingJobsTableId := getenv "HUGO_AIRTABLE_PAYING_JOBS_TABLE_ID" }}
{{ $airtableUpcomingSittingsViewId := getenv "HUGO_AIRTABLE_UPCOMING_SITTINGS_VIEW_ID" }}

{{ $airtableQuerystring := printf "?view=%s&fields%%5B%%5D=Start+at&fields%%5B%%5D=End+at" $airtableUpcomingSittingsViewId }}
{{ $airtableHeaders := dict "Authorization" (printf "Bearer %s" $airtableAuthToken) }}

{{ $payingJobs := getJSON "https://api.airtable.com/v0/" $airtableBaseId "/" $airtablePayingJobsTableId $airtableQuerystring $airtableHeaders }}

{{/* These need updating along with the logic over time. */}}
{{ $bstEnd := time "2023-10-29T01:00:00Z" }}
{{ $bstStart := time "2024-03-31T01:00:00Z" }}

{{ $holidayDates := slice
  (time "2023-12-23")
  (time "2023-12-24")
  (time "2023-12-25")
  (time "2023-12-26")
  (time "2023-12-27")
  (time "2023-12-28")
  (time "2023-12-29")
  (time "2023-12-30")
  (time "2023-12-31")
  (time "2024-01-01")
  (time "2024-01-02")
}}

{{ $startDates := slice }}
{{ $endDates := slice }}
{{ $busyDates := slice }}
{{ range $payingJobs.records }}
  {{ $startAt := index .fields "Start at" | time }}
  {{ $startOn := $startAt.Format "2006-01-02" | time }}
  {{ if not (in $startDates $startOn) }}
    {{ $startDates = $startDates | append $startOn }}
  {{ end }}

  {{/* Treat as "busy" if starting before 12:00 in the local time. */}}
  {{ $busyBeforeHourAtStart := 12 }}
  {{ if or ($startAt.Before $bstEnd) ($startAt.After $bstStart) }}
    {{ $busyBeforeHourAtStart = 11 }}
  {{ end }}
  {{ if and (lt $startAt.Hour $busyBeforeHourAtStart) (not (in $busyDates $startOn)) }}
    {{ $busyDates = $busyDates | append $startOn }}
  {{ end }}

  {{ $endAt := index .fields "End at" | time }}
  {{ $endOn := $endAt.Format "2006-01-02" | time }}
  {{ if not (in $endDates $endOn) }}
    {{ $endDates = $endDates | append $endOn }}
  {{ end }}

  {{/* Treat as "busy" if ending on or after 17:00 in the local time. */}}
  {{ $busyOnOrAfterHourAtEnd := 17 }}
  {{ if or ($endAt.Before $bstEnd) ($endAt.After $bstStart) }}
    {{ $busyOnOrAfterHourAtEnd = 16 }}
  {{ end }}
  {{ if and (ge $endAt.Hour $busyOnOrAfterHourAtEnd) (not (in $busyDates $endOn)) }}
    {{ $busyDates = $busyDates | append $endOn }}
  {{ end }}

  {{ $d := $startOn.AddDate 0 0 1 }}
  {{ range seq 1000 }}
    {{ if $d.After ($endOn.AddDate 0 0 -1) }}
      {{ break }}
    {{ end }}

    {{ if not (in $busyDates $d) }}
      {{ $busyDates = $busyDates | append $d }}
    {{ end }}

    {{ $d = $d.AddDate 0 0 1 }}
  {{ end }}
{{ end }}

<div>

  <div class="overnight-calendar">
    {{ $monthsToShow := 4 }}

    {{ $day := printf "%s-01" (time.Now.Format "2006-01") | time }}
    {{ $prevDay := $day.AddDate 0 0 -1 }}
    {{ range $monthCounter := seq $monthsToShow }}
      <div id="overnight-calendar-{{ $day.Format "2006-01" }}">
        <time datetime="{{ $day.Format "2006-01" }}">
          <div>
            {{ if gt $monthCounter 1 }}
              <a href="#overnight-calendar-{{ ((printf "%s-01" ($day.Format "2006-01") | time).AddDate 0 -1 0).Format "2006-01" }}">⬅&#xFE0E;</a>
            {{ end }}
            <span>{{ $day.Format "January 2006" }}</span>
            {{ if lt $monthCounter $monthsToShow }}
              <a href="#overnight-calendar-{{ ((printf "%s-01" ($day.Format "2006-01") | time).AddDate 0 1 0).Format "2006-01" }}">⮕&#xFE0E;</a>
            {{ end }}
          </div>

          <div>
            <span>Su</span>
            <span>Mo</span>
            <span>Tu</span>
            <span>We</span>
            <span>Th</span>
            <span>Fr</span>
            <span>Sa</span>
          </div>

          {{ range seq 6 }}
            <div>
              {{ range seq 7 }}
                {{ $dayStatus := "none" }}
                {{ if $day.Before (time.Now.AddDate 0 0 -1) }}
                  {{ $dayStatus = "past" }}
                {{ else if or (in $busyDates $day) (and (in $startDates $day) (in $endDates $day)) }}
                  {{ $dayStatus = "busy" }}
                {{ else if in $startDates $day }}
                  {{ $dayStatus = "starting" }}
                {{ else if in $endDates $day }}
                  {{ $dayStatus = "ending" }}
                {{ end }}

                <time
                  datetime="{{ $day.Format "2006-01-02" }}"
                  data-status="{{ $dayStatus }}"
                  data-holiday="{{ in $holidayDates $day }}"
                  >{{ $day.Day }}</time>

                {{ $prevDay = $day }}
                {{ $day = $day.AddDate 0 0 1 }}

                {{ if ne $prevDay.Month $day.Month }}
                  {{ break }}
                {{ end }}

                {{ if gt (int $prevDay.Weekday) (int $day.Weekday) }}
                  {{ break }}
                {{ end }}
              {{ end }}
            </div>

            {{ if ne $prevDay.Month $day.Month }}
              {{ break }}
            {{ end }}
          {{ end }}
        </time>
      </div>
    {{ end }}
  </div>

  <legend>
    <div>
      <time datetime="{{ time.Now.Format "2006-01-02" }}" data-status="busy">{{ time.Now.Day }}</time> unavailable for overnight services
    </div>
    <div>
      <time datetime="2023-12-25" data-holiday="true">25</time> holiday period
    </div>
  </legend>

</div>

<style>
  .overnight-calendar {
    margin-top: -3.5em;
    display: flex;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    user-select: none;
  }

  .overnight-calendar > div {
    margin-bottom: 1px;
    flex-shrink: 0;
    flex-basis: 100%;
    scroll-snap-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .overnight-calendar > div > time > :first-child {
    position: relative;
    margin: 4em 0 1em;
    font-weight: bold;
  }

  .overnight-calendar > div > time > :first-child > a {
    position: absolute;
    text-decoration: none;
  }

  .overnight-calendar > div > time > :first-child > a:first-child {
    left: 0;
    padding-right: 2em;
  }

  .overnight-calendar > div > time > :first-child > a:last-child {
    right: 0;
    padding-left: 2em;
  }

  .overnight-calendar > div > time > :not(:first-child) {
    display: flex;
    justify-content: flex-start;
  }

  .overnight-calendar > div > time > :nth-child(2) > span {
    font-style: italic;
  }

  .overnight-calendar > div > time > :nth-child(3) {
    justify-content: flex-end;
  }

  .overnight-calendar > div > time > :nth-child(2) > span,
  .overnight-calendar > div > time time,
  .overnight-calendar ~ legend time {
    position:relative;
    width: 2.5em;
    height: 2.5em;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .overnight-calendar > div > time > :nth-child(2) > span {
    margin: 1px;
  }

  .overnight-calendar > div > time time,
  .overnight-calendar ~ legend time {
    flex-shrink: 0;
    margin: -1px;
    border: 2px solid black;
  }

  .overnight-calendar > div > time time[data-status="past"] {
    opacity: 0;
  }

  .overnight-calendar > div > time time[data-status="past"]::after {
    content: "";
    position: absolute;
    border-top: 1px solid black;
    width: 200%;
    transform: rotate(45deg);
  }

  .overnight-calendar > div > time time[data-status="busy"],
  .overnight-calendar > div > time time[data-status="starting"]::after,
  .overnight-calendar > div > time time[data-status="ending"]::after,
  .overnight-calendar ~ legend time[data-status="busy"] {
    background-color: rgba(0, 0, 0, 0.3);
  }

  .overnight-calendar > div > time time:not([data-status="busy"])[data-holiday="true"],
  .overnight-calendar ~ legend time:not([data-status="busy"])[data-holiday="true"] {
    background-color: var(--accent-colour);
  }

  .overnight-calendar > div > time time[data-status="starting"]::after,
  .overnight-calendar > div > time time[data-status="ending"]::after {
    content: "";
    position: absolute;
    width: 200%;
    top: 50%;
    bottom: -50%;
    transform-origin: top center;
  }

  .overnight-calendar > div > time time[data-status="starting"]::after {
    transform: rotate(-45deg);
  }

  .overnight-calendar > div > time time[data-status="ending"]::after {
    transform: rotate(135deg);
  }

  .overnight-calendar ~ legend {
    margin-top: 1em;
  }

  .overnight-calendar ~ legend > div {
    display: flex;
    gap: 0.5em;
    align-items: center;
  }
</style>
